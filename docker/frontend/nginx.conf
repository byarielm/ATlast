events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Security headers applied to all responses.
    # These protect against common web attacks:
    # - X-Frame-Options: prevents clickjacking (your page in an iframe)
    # - X-Content-Type-Options: prevents MIME sniffing attacks
    # - Referrer-Policy: limits URL info sent to third parties
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    server {
        listen 80;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Gzip compression: reduces transfer size for text assets.
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

        # API proxy: forward /api/* requests to the Hono API container.
        #
        # Without this proxy, the browser would send /api/search to the frontend
        # domain, which does not handle API requests. We would need CORS headers.
        # With this proxy, the browser sees ONE origin for everything.
        # The api container is reachable via Docker's internal DNS as "api:3000".
        location /api/ {
            proxy_pass http://api:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # SPA routing: for any path that does not match a real file,
        # serve index.html and let React Router handle the navigation.
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Cache static assets aggressively.
        # Vite adds content hashes to filenames (e.g., main.a1b2c3.js),
        # so these URLs never change for the same content.
        # Browsers can cache them for a full year safely.
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
